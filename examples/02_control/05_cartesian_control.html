<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cartesian control &mdash; XDE examples 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/josini.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="XDE examples 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Control robots" href="../02_control.html" />
    <link rel="next" title="Kinematic control" href="06_kinematic_control.html" />
    <link rel="prev" title="Waiting for the controller for non-real time simulations" href="04_control_sync_with_clock_and_controller.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="06_kinematic_control.html" title="Kinematic control"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="04_control_sync_with_clock_and_controller.html" title="Waiting for the controller for non-real time simulations"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">XDE examples 0.1 documentation</a> &raquo;</li>
          <li><a href="../02_control.html" accesskey="U">Control robots</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="cartesian-control">
<h1>Cartesian control<a class="headerlink" href="#cartesian-control" title="Permalink to this headline">¶</a></h1>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">This example show how to build a simple cartesian controller for a pendulum</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Get source of this example:</p>
<ul class="last simple">
<li><a class="reference download internal" href="../../_downloads/common7.py"><tt class="xref download docutils literal"><span class="pre">common.py</span></tt></a>.</li>
<li><a class="reference download internal" href="../../_downloads/main10.py"><tt class="xref download docutils literal"><span class="pre">main.py</span></tt></a>.</li>
</ul>
</div>
<div class="section" id="the-cartesian-controller">
<h2>The cartesian controller<a class="headerlink" href="#the-cartesian-controller" title="Permalink to this headline">¶</a></h2>
<p>The controller is an Orocos component. In this example we use python to implement it.
In the initialisation, we create a multibody_model, that is updated to be representative
of state of the simulated robot and used to compute when needed
jacobians for instance.
Then in the updateHook, the current joint positions/velocities are read from the robot state,
and those are used as desired positions/velocities.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CartesianController</span><span class="p">(</span><span class="n">xdefw</span><span class="o">.</span><span class="n">rtt</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
  
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taskName</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">robotName</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">rtt_interface</span><span class="o">.</span><span class="n">PyTaskFactory</span><span class="o">.</span><span class="n">CreateTask</span><span class="p">(</span><span class="n">taskName</span><span class="p">)</span>
        <span class="n">xdefw</span><span class="o">.</span><span class="n">rtt</span><span class="o">.</span><span class="n">Task</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>

        <span class="n">multiBodyModel</span> <span class="o">=</span> <span class="n">xde</span><span class="o">.</span><span class="n">desc</span><span class="o">.</span><span class="n">physic</span><span class="o">.</span><span class="n">physic_pb2</span><span class="o">.</span><span class="n">MultiBodyModel</span><span class="p">()</span>
        <span class="n">mechanism_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">physical_scene</span><span class="o">.</span><span class="n">mechanisms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robotName</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mechanism_index</span> <span class="o">=</span> <span class="n">mechanism_index</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">multiBodyModel</span><span class="o">.</span><span class="n">kinematic_tree</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">physical_scene</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span> <span class="n">mechanism_index</span> <span class="p">])</span>
        <span class="n">multiBodyModel</span><span class="o">.</span><span class="n">meshes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">meshes</span><span class="p">)</span>
        <span class="n">multiBodyModel</span><span class="o">.</span><span class="n">mechanism</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">physical_scene</span><span class="o">.</span><span class="n">mechanisms</span><span class="p">[</span> <span class="n">mechanism_index</span> <span class="p">])</span>
        <span class="n">multiBodyModel</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">physical_scene</span><span class="o">.</span><span class="n">collision_scene</span><span class="o">.</span><span class="n">meshes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">physicshelper</span><span class="o">.</span><span class="n">createDynamicModel</span><span class="p">(</span><span class="n">multiBodyModel</span><span class="p">)</span>

        <span class="c"># Input port to read the current state of the robot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCreateInputPort</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="s">&quot;VectorXd&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_ok</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="c"># Input port to read the current state of the robot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qdot_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCreateInputPort</span><span class="p">(</span><span class="s">&quot;qdot&quot;</span><span class="p">,</span> <span class="s">&quot;VectorXd&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qdot_ok</span> <span class="o">=</span> <span class="bp">False</span>
    
        <span class="c"># Output port to write torque commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCreateOutputPort</span><span class="p">(</span><span class="s">&quot;tau&quot;</span><span class="p">,</span> <span class="s">&quot;VectorXd&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">kp</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">=</span> <span class="mi">20</span>
  
    <span class="k">def</span> <span class="nf">startHook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
  
    <span class="k">def</span> <span class="nf">stopHook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
  
    <span class="k">def</span> <span class="nf">updateHook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try to read new value of robot state</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">q_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_in</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdot_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qdot</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">qdot_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdot_in</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_ok</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdot_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_ok</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qdot_ok</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doUpdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qdot</span><span class="p">)</span>

  
    <span class="k">def</span> <span class="nf">doUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">qdot</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setJointPositions</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setJointVelocities</span><span class="p">(</span><span class="n">qdot</span><span class="p">)</span>
        
        <span class="n">H6</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">getSegmentPosition</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">getSegmentIndex</span><span class="p">(</span><span class="s">&quot;p1_b_3&quot;</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">lgsm</span><span class="o">.</span><span class="n">Displacement</span><span class="p">()</span>
        <span class="n">H</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">lgsm</span><span class="o">.</span><span class="n">vectord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">H</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">H6</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>
        <span class="n">J66</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">getSegmentJacobian</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">getSegmentIndex</span><span class="p">(</span><span class="s">&quot;p1_b_3&quot;</span><span class="p">))</span>
        <span class="n">J60</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span> <span class="o">*</span> <span class="n">J66</span>
        <span class="n">T60</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">getSegmentVelocity</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">getSegmentIndex</span><span class="p">(</span><span class="s">&quot;p1_b_3&quot;</span><span class="p">))</span>
    
        <span class="n">Xdes</span> <span class="o">=</span> <span class="n">lgsm</span><span class="o">.</span><span class="n">Displacement</span><span class="p">(</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
         
        <span class="n">xd</span> <span class="o">=</span> <span class="n">Xdes</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span> <span class="c"># desired position of the effector</span>
        <span class="n">x</span>  <span class="o">=</span> <span class="n">H6</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">T60</span><span class="o">.</span><span class="n">getLinearVelocity</span><span class="p">()</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kp</span> <span class="o">*</span> <span class="p">(</span><span class="n">xd</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">*</span> <span class="n">v</span>
    
        <span class="c">#tau = lgsm.vector([0] * model.nbInternalDofs())</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">J60</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">fc</span>
        
        <span class="n">tau</span> <span class="o">+=</span> <span class="n">model</span><span class="o">.</span><span class="n">getGravityTerms</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="association-with-the-robot">
<h2>Association with the robot<a class="headerlink" href="#association-with-the-robot" title="Permalink to this headline">¶</a></h2>
<p>The controller is then instanciated and associated to the robot p1.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create controller</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">CartesianController</span><span class="p">(</span><span class="s">&quot;MyController&quot;</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="s">&quot;p1&quot;</span><span class="p">)</span> <span class="c"># ControllerName, the world instance, RobotName</span>
<span class="n">controller</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">setPeriod</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to read the state of the robot, we need to create a special connector:
the OConnectorRobotState which will add ports to the physic agent.
The argument are <tt class="docutils literal"><span class="pre">Connectors.OConnectorRobotState.new(connector_name,</span> <span class="pre">prefix_port_name,</span> <span class="pre">robot_name)</span></tt>.
The <tt class="docutils literal"><span class="pre">prefix_port_name</span></tt> will be use to prefix the name of the new ports.
The state of the associated robot be written in those ports. Connecting
input ports to those generated ports will allow us to read the state of the robot.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">phy</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">Connectors</span><span class="o">.</span><span class="n">OConnectorRobotState</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;ocpos&quot;</span><span class="p">,</span> <span class="s">&quot;p1_&quot;</span><span class="p">,</span> <span class="s">&quot;p1&quot;</span><span class="p">)</span>         <span class="c"># ConnectorName, PortName, RobotName</span>
                                                                        <span class="c"># It generates two ports named &quot;PortName&quot;+&quot;q&quot; &amp; &quot;PortName&quot;+&quot;qdpt&quot;</span>
</pre></div>
</div>
<p>A similar connector has to be created to send command to the robot:
the creation of a IConnectorRobotJointTorque will add a port to the physic agent.
This port has to be plugged to an output port where a torque command is written.
Typically, it is plugged to the output of a controller.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">phy</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">Connectors</span><span class="o">.</span><span class="n">IConnectorRobotJointTorque</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;icjt&quot;</span><span class="p">,</span> <span class="s">&quot;p1_&quot;</span><span class="p">,</span> <span class="s">&quot;p1&quot;</span><span class="p">)</span>    <span class="c"># ConnectorName, PortName, RobotName</span>
                                                                        <span class="c"># It generates a port named &quot;PortName&quot;+&quot;tau&quot;</span>
</pre></div>
</div>
<p>Then we have to connect the controller and the ports added by the creation of the connectors:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">phy</span><span class="o">.</span><span class="n">getPort</span><span class="p">(</span><span class="s">&#39;p1_q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">connectTo</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">getPort</span><span class="p">(</span><span class="s">&#39;q&#39;</span><span class="p">))</span>
<span class="n">phy</span><span class="o">.</span><span class="n">getPort</span><span class="p">(</span><span class="s">&#39;p1_qdot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">connectTo</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">getPort</span><span class="p">(</span><span class="s">&#39;qdot&#39;</span><span class="p">))</span>

<span class="n">controller</span><span class="o">.</span><span class="n">getPort</span><span class="p">(</span><span class="s">&quot;tau&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">connectTo</span><span class="p">(</span><span class="n">phy</span><span class="o">.</span><span class="n">getPort</span><span class="p">(</span><span class="s">&quot;p1_tau&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cartesian control</a><ul>
<li><a class="reference internal" href="#the-cartesian-controller">The cartesian controller</a></li>
<li><a class="reference internal" href="#association-with-the-robot">Association with the robot</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="04_control_sync_with_clock_and_controller.html"
                        title="previous chapter">Waiting for the controller for non-real time simulations</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="06_kinematic_control.html"
                        title="next chapter">Kinematic control</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/examples/02_control/05_cartesian_control.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="06_kinematic_control.html" title="Kinematic control"
             >next</a> |</li>
        <li class="right" >
          <a href="04_control_sync_with_clock_and_controller.html" title="Waiting for the controller for non-real time simulations"
             >previous</a> |</li>
        <li><a href="../../index.html">XDE examples 0.1 documentation</a> &raquo;</li>
          <li><a href="../02_control.html" >Control robots</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Joseph Salini, Sovannara Hak.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>